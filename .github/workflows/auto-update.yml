name: Update yt-dlp and Build App

on:
  schedule:
    # Run weekly
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual trigger
    inputs:
      force_update:
        description: 'Force build regardless of yt-dlp version'
        required: true
        default: 'false'
        type: boolean

jobs:
  update-and-build:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      actions: write
      security-events: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get current yt-dlp version from requirements.txt
      id: current_version
      run: |
        # Extract version from requirements.txt (handles both == and >= formats)
        CURRENT_VERSION=$(grep -E "^yt-dlp\s*[=>]" requirements.txt | head -1 | sed -E 's/^yt-dlp\s*[=>]+\s*([0-9.]+).*/\1/')
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current yt-dlp version: $CURRENT_VERSION"

    - name: Get latest yt-dlp version from PyPI
      id: latest_version
      run: |
        LATEST_VERSION=$(curl -s https://pypi.org/pypi/yt-dlp/json | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
        echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "Latest yt-dlp version: $LATEST_VERSION"

    - name: Compare versions and check force update
      id: version_check
      run: |
        CURRENT="${{ steps.current_version.outputs.current }}"
        LATEST="${{ steps.latest_version.outputs.latest }}"
        FORCE="${{ github.event.inputs.force_update || 'false' }}"
        
        VERSION_CHANGED="false"
        NEEDS_BUILD="false"
        
        if [ "$CURRENT" != "$LATEST" ]; then
          VERSION_CHANGED="true"
          NEEDS_BUILD="true"
          echo "yt-dlp needs update from $CURRENT to $LATEST"
        else
          echo "yt-dlp is already up to date ($CURRENT)"
        fi
        
        if [ "$FORCE" == "true" ]; then
          NEEDS_BUILD="true"
          echo "Force update is enabled. Build will proceed."
        fi
        
        echo "version_changed=$VERSION_CHANGED" >> $GITHUB_OUTPUT
        echo "needs_update=$NEEDS_BUILD" >> $GITHUB_OUTPUT

    - name: Update requirements.txt
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        LATEST_VERSION="${{ steps.latest_version.outputs.latest }}"
        # Update the versioned yt-dlp line
        sed -i -E "s/^yt-dlp\s*==\s*[0-9.]+.*$/yt-dlp == $LATEST_VERSION/" requirements.txt
        echo "Updated requirements.txt with yt-dlp == $LATEST_VERSION"

    - name: Get current app version
      if: steps.version_check.outputs.needs_update == 'true'
      id: current_app_version
      run: |
        CURRENT_APP_VERSION=$(sed -n 's/.*["'\'']\([0-9.]*\)["'\''].*/\1/p' src/_version.py)
        echo "current_app=$CURRENT_APP_VERSION" >> $GITHUB_OUTPUT
        echo "Current app version: $CURRENT_APP_VERSION"

    - name: Bump patch version
      if: steps.version_check.outputs.needs_update == 'true'
      id: bump_version
      run: |
        CURRENT_APP_VERSION=${{ steps.current_app_version.outputs.current_app }}
        
        # Extract version parts
        MAJOR=$(echo $CURRENT_APP_VERSION | cut -d. -f1)
        MINOR=$(echo $CURRENT_APP_VERSION | cut -d. -f2)
        PATCH=$(echo $CURRENT_APP_VERSION | cut -d. -f3)
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        # Update _version.py by writing the entire file content
        echo "__version__ = '$NEW_VERSION'" > src/_version.py
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped version from $CURRENT_APP_VERSION to $NEW_VERSION"

    - name: Build with Buildozer Action
      if: steps.version_check.outputs.needs_update == 'true'
      uses: ArtemSBulgakov/buildozer-action@v1.2.0
      id: buildozer
      env:
        USER: root
        PIP_BREAK_SYSTEM_PACKAGES: 1
        HOME: /root
      with:
        command: buildozer android release

    - name: Fix git permissions
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        sudo chown -R $(whoami):$(whoami) .
        sudo chmod -R 755 .git

    - name: Create keystore file from secret
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > mykeystore.keystore
        chmod 600 mykeystore.keystore

    - name: Setup Android SDK
      if: steps.version_check.outputs.needs_update == 'true'
      uses: android-actions/setup-android@v3

    - name: Sign APK with zipalign
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        # Use the output from buildozer action
        UNSIGNED_APK="${{ steps.buildozer.outputs.filename }}"
        
        if [ -z "$UNSIGNED_APK" ] || [ ! -f "$UNSIGNED_APK" ]; then
          echo "Error: Could not find unsigned APK at $UNSIGNED_APK"
          exit 1
        fi
        
        echo "Found unsigned APK: $UNSIGNED_APK"
        
        # Create bin directory if it doesn't exist
        mkdir -p bin
        
        # Set Android SDK paths
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        
        # Find the latest build-tools version
        BUILD_TOOLS_VERSION=$(ls -1 $ANDROID_HOME/build-tools | sort -V | tail -n 1)
        echo "Using build-tools version: $BUILD_TOOLS_VERSION"
        
        # Set full paths to zipalign and apksigner
        ZIPALIGN="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/zipalign"
        APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
        
        echo "Using zipalign: $ZIPALIGN"
        echo "Using apksigner: $APKSIGNER"
        
        # Verify the tools exist
        if [ ! -f "$ZIPALIGN" ]; then
          echo "Error: zipalign not found at $ZIPALIGN"
          exit 1
        fi
        
        if [ ! -f "$APKSIGNER" ]; then
          echo "Error: apksigner not found at $APKSIGNER"
          exit 1
        fi
        
        # Align the APK
        $ZIPALIGN -v -p 4 "$UNSIGNED_APK" youtube_dl_kivy-aligned.apk
        
        # Sign the aligned APK
        $APKSIGNER sign \
          --ks mykeystore.keystore \
          --ks-pass "pass:${{ secrets.KEYSTORE_PASSPHRASE }}" \
          --out bin/youtube_dl_kivy.apk \
          youtube_dl_kivy-aligned.apk
        
        # Verify the signature
        $APKSIGNER verify bin/youtube_dl_kivy.apk
        
        echo "✅ APK signed successfully: bin/youtube_dl_kivy.apk"
    
    - name: Commit and push changes
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        git add requirements.txt src/_version.py
        git commit -m "chore: update yt-dlp to ${{ steps.latest_version.outputs.latest }} and bump version to ${{ steps.bump_version.outputs.new_version }}"
        git push

    - name: Verify APK exists
      if: steps.version_check.outputs.needs_update == 'true'
      id: verify_apk
      run: |
        if [ -f "bin/youtube_dl_kivy.apk" ]; then
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          echo "✅ APK file found"
        else
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          echo "❌ APK file not found"
          exit 1
        fi

    - name: Create Release
      if: steps.version_check.outputs.needs_update == 'true' && steps.verify_apk.outputs.apk_exists == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ steps.bump_version.outputs.new_version }}"
        name: "Release v${{ steps.bump_version.outputs.new_version }}"
        body: |
          ## Changes
          - Updated yt-dlp from ${{ steps.current_version.outputs.current }} to ${{ steps.latest_version.outputs.latest }}
          - Bumped app version to ${{ steps.bump_version.outputs.new_version }}
          
          ## Built with
          - yt-dlp: ${{ steps.latest_version.outputs.latest }}
          - Build date: ${{ github.run_id }}
        files: "bin/youtube_dl_kivy.apk"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- yt-dlp updated from ${{ steps.current_version.outputs.current }} to ${{ steps.latest_version.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          echo "- App version bumped to ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- APK built and released successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "## No Update Needed" >> $GITHUB_STEP_SUMMARY
          echo "yt-dlp is already up to date (version ${{ steps.current_version.outputs.current }})" >> $GITHUB_STEP_SUMMARY
          echo "Next check: Next Monday at 2 AM UTC" >> $GITHUB_STEP_SUMMARY
        fi