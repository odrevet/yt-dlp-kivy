name: Update yt-dlp and Build App

on:
  schedule:
    # Run weekly
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual trigger
    inputs:
      force_update:
        description: 'Force build regardless of yt-dlp version'
        required: true
        default: 'false'
        type: boolean

jobs:
  update-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      security-events: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # Python is still needed for the version checking steps
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Get current yt-dlp version from requirements.txt
      id: current_version
      run: |
        # Extract version from requirements.txt (handles both == and >= formats)
        CURRENT_VERSION=$(grep -E "^yt-dlp\s*[=>]" requirements.txt | head -1 | sed -E 's/^yt-dlp\s*[=>]+\s*([0-9.]+).*/\1/')
        echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current yt-dlp version: $CURRENT_VERSION"

    - name: Get latest yt-dlp version from PyPI
      id: latest_version
      run: |
        LATEST_VERSION=$(curl -s https://pypi.org/pypi/yt-dlp/json | python -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
        echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT
        echo "Latest yt-dlp version: $LATEST_VERSION"

    - name: Compare versions and check force update
      id: version_check
      run: |
        CURRENT="${{ steps.current_version.outputs.current }}"
        LATEST="${{ steps.latest_version.outputs.latest }}"
        FORCE="${{ github.event.inputs.force_update || 'false' }}"
        
        VERSION_CHANGED="false"
        NEEDS_BUILD="false"
        
        if [ "$CURRENT" != "$LATEST" ]; then
          VERSION_CHANGED="true"
          NEEDS_BUILD="true"
          echo "yt-dlp needs update from $CURRENT to $LATEST"
        else
          echo "yt-dlp is already up to date ($CURRENT)"
        fi
        
        if [ "$FORCE" == "true" ]; then
          NEEDS_BUILD="true"
          echo "Force update is enabled. Build will proceed."
        fi
        
        echo "version_changed=$VERSION_CHANGED" >> $GITHUB_OUTPUT
        echo "needs_update=$NEEDS_BUILD" >> $GITHUB_OUTPUT

    - name: Update requirements.txt
      if: steps.version_check.outputs.version_changed == 'true'
      run: |
        LATEST_VERSION="${{ steps.latest_version.outputs.latest }}"
        # Update the versioned yt-dlp line
        sed -i -E "s/^yt-dlp\s*==\s*[0-9.]+.*$/yt-dlp == $LATEST_VERSION/" requirements.txt
        echo "Updated requirements.txt with yt-dlp == $LATEST_VERSION"

    - name: Get current app version
      if: steps.version_check.outputs.needs_update == 'true'
      id: current_app_version
      run: |
        CURRENT_APP_VERSION=$(sed -n 's/.*["'\'']\([0-9.]*\)["'\''].*/\1/p' src/_version.py)
        echo "current_app=$CURRENT_APP_VERSION" >> $GITHUB_OUTPUT
        echo "Current app version: $CURRENT_APP_VERSION"

    - name: Bump patch version
      if: steps.version_check.outputs.needs_update == 'true'
      id: bump_version
      run: |
        CURRENT_APP_VERSION=${{ steps.current_app_version.outputs.current_app }}
        
        # Extract version parts
        MAJOR=$(echo $CURRENT_APP_VERSION | cut -d. -f1)
        MINOR=$(echo $CURRENT_APP_VERSION | cut -d. -f2)
        PATCH=$(echo $CURRENT_APP_VERSION | cut -d. -f3)
        
        # Increment patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        # Update _version.py by writing the entire file content
        echo "__version__ = '$NEW_VERSION'" > src/_version.py
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Bumped version from $CURRENT_APP_VERSION to $NEW_VERSION"

    - name: Create keystore file from secret
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > mykeystore.keystore
        chmod 600 mykeystore.keystore

    - name: Build with Buildozer Action
      if: steps.version_check.outputs.needs_update == 'true'
      uses: ArtemSBulgakov/buildozer-action@v1
      env:
        # Fix for "chown: invalid user: 'user'" error
        USER: root
        # Fix for PEP 668 "externally-managed-environment" error in Python 3.12+
        PIP_BREAK_SYSTEM_PACKAGES: 1
        # Fix for path mismatch: ensure HOME points to where root installs tools
        HOME: /root
      with:
        # Build unsigned release first
        command: buildozer android release

    - name: Fix git permissions
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        sudo chown -R $(whoami):$(whoami) .
        sudo chmod -R 755 .git
        
    - name: Sign APK
      if: steps.version_check.outputs.needs_update == 'true'
      uses: r0adkll/sign-android-release@v1
      with:
        releaseDirectory: bin
        signingKeyBase64: ${{ secrets.KEYSTORE_BASE64 }}
        alias: ${{ secrets.KEYSTORE_ALIAS }} # Ensure this secret is set in your repo
        keyStorePassword: ${{ secrets.KEYSTORE_PASSPHRASE }}
        keyPassword: ${{ secrets.KEYSTORE_PASSPHRASE }}
      env:
        # Override build tools version if necessary, or let the action find it
        BUILD_TOOLS_VERSION: "34.0.0" # Adjust this version if needed, or remove to let action detect
    
    - name: Commit and push changes
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        
        # Only add requirements.txt if it actually changed
        if [ "${{ steps.version_check.outputs.version_changed }}" == "true" ]; then
          git add requirements.txt
        fi
        
        git add src/_version.py
        git commit -m "chore: build release ${{ steps.bump_version.outputs.new_version }}"
        git push

    - name: Create Release
      if: steps.version_check.outputs.needs_update == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ steps.bump_version.outputs.new_version }}"
        name: "Release v${{ steps.bump_version.outputs.new_version }}"
        body: |
          ## Changes
          ${{ steps.version_check.outputs.version_changed == 'true' && format('- Updated yt-dlp from {0} to {1}', steps.current_version.outputs.current, steps.latest_version.outputs.latest) || '- No yt-dlp version change (Forced build)' }}
          - Bumped app version to ${{ steps.bump_version.outputs.new_version }}
          
          ## Built with
          - yt-dlp: ${{ steps.latest_version.outputs.latest }}
          - Build date: ${{ github.run_id }}
        # The signing action renames the file, usually to *-signed-release.apk
        # We use a wildcard to catch the name change
        files: "bin/*-release.apk" 
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Summary
      run: |
        if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version_check.outputs.version_changed }}" == "true" ]; then
            echo "- yt-dlp updated from ${{ steps.current_version.outputs.current }} to ${{ steps.latest_version.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Force build triggered (no yt-dlp version change)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- App version bumped to ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- APK built and released successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "## No Update Needed" >> $GITHUB_STEP_SUMMARY
          echo "yt-dlp is already up to date (version ${{ steps.current_version.outputs.current }})" >> $GITHUB_STEP_SUMMARY
          echo "Next check: Next Monday at 2 AM UTC" >> $GITHUB_STEP_SUMMARY
        fi